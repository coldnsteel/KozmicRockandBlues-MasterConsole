<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KozmicRockandBlues-MasterConsole</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            font-family: 'Courier New', monospace;
            overflow-x: hidden;
        }
        
        .console-container {
            padding: 15px;
            max-width: 100vw;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            background: rgba(255, 107, 157, 0.1);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #ff6b9d;
        }
        
        .header h1 {
            margin: 0;
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4, #ffd93d);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: clamp(1.2rem, 3.5vw, 2rem);
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .section {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #4ecdc4;
            border-radius: 15px;
            padding: 15px;
        }
        
        .section h3 {
            color: #4ecdc4;
            margin: 0 0 15px 0;
            font-size: 1rem;
            text-align: center;
        }
        
        .video-section {
            position: relative;
            background: rgba(255, 107, 157, 0.1);
            border: 2px solid #ff6b9d;
            height: 200px;
        }
        
        #guitarVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            background: radial-gradient(circle, #1a1a2e, #000);
        }
        
        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }
        
        .effects-rack {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .effect-knob {
            text-align: center;
            background: rgba(76, 205, 196, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #4ecdc4;
        }
        
        .knob {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
            margin: 5px auto;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .knob:hover {
            transform: scale(1.1);
        }
        
        .knob::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 15px;
            background: white;
            border-radius: 2px;
        }
        
        .knob-label {
            font-size: 0.7rem;
            margin: 5px 0;
            color: #4ecdc4;
        }
        
        .knob-value {
            font-size: 0.8rem;
            color: #ffd93d;
        }
        
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .rhythm-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .btn {
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            font-family: inherit;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }
        
        .btn.active {
            background: linear-gradient(45deg, #ffd93d, #ff6b9d);
            box-shadow: 0 0 20px rgba(255, 217, 61, 0.5);
        }
        
        .btn.small {
            padding: 6px 10px;
            font-size: 0.7rem;
        }
        
        .record-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .record-section .btn {
            flex: 1;
            min-width: 100px;
        }
        
        .bpm-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            justify-content: center;
        }
        
        .bpm-display {
            background: rgba(255, 217, 61, 0.2);
            padding: 5px 15px;
            border-radius: 8px;
            border: 1px solid #ffd93d;
            color: #ffd93d;
            font-weight: bold;
        }
        
        .speech-section {
            background: rgba(255, 217, 61, 0.1);
            border: 2px solid #ffd93d;
        }
        
        .speech-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .speech-controls .btn {
            flex: 1;
            min-width: 80px;
        }
        
        .speech-commands {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ffd93d;
            max-height: 100px;
            overflow-y: auto;
            font-size: 0.7rem;
        }
        
        .status-bar {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #4ecdc4;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            color: #4ecdc4;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .status-value {
            color: #ffd93d;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .guitar-strings {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin: 10px 0;
        }
        
        .string {
            height: 2px;
            background: linear-gradient(90deg, #ff6b9d, #4ecdc4);
            border-radius: 1px;
            transition: all 0.3s ease;
        }
        
        .string.vibrating {
            animation: vibrate 0.5s ease-in-out;
        }
        
        @keyframes vibrate {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(3); }
        }
        
        .footer {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 1px solid #4ecdc4;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .effects-rack {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .record-section {
                flex-direction: column;
            }
            
            .speech-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="console-container">
        <div class="header">
            <h1>üé∏ KOZMIC ROCK & BLUES MASTER CONSOLE üé§</h1>
            <p>Professional Live Performance Studio</p>
        </div>
        
        <div class="main-grid">
            <div class="section video-section">
                <h3>üìπ Live Feed</h3>
                <video id="guitarVideo" autoplay muted playsinline>
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #4ecdc4;">
                        üìπ Video Feed Will Appear Here
                    </div>
                </video>
                <div class="video-controls">
                    <button class="btn small" onclick="toggleVideo()">Start Video</button>
                    <button class="btn small" onclick="toggleVideoRecord()">Record Video</button>
                </div>
            </div>
            
            <div class="section">
                <h3>üéõÔ∏è Effects Rack</h3>
                <div class="effects-rack">
                    <div class="effect-knob">
                        <div class="knob" onclick="adjustLiveEffect('slide')"></div>
                        <div class="knob-label">Slide</div>
                        <div class="knob-value" id="slideValue">0%</div>
                    </div>
                    <div class="effect-knob">
                        <div class="knob" onclick="adjustLiveEffect('drive')"></div>
                        <div class="knob-label">Drive</div>
                        <div class="knob-value" id="driveValue">0%</div>
                    </div>
                    <div class="effect-knob">
                        <div class="knob" onclick="adjustLiveEffect('reverb')"></div>
                        <div class="knob-label">Reverb</div>
                        <div class="knob-value" id="reverbValue">0%</div>
                    </div>
                    <div class="effect-knob">
                        <div class="knob" onclick="adjustLiveEffect('delay')"></div>
                        <div class="knob-label">Delay</div>
                        <div class="knob-value" id="delayValue">0%</div>
                    </div>
                    <div class="effect-knob">
                        <div class="knob" onclick="adjustLiveEffect('wah')"></div>
                        <div class="knob-label">Wah</div>
                        <div class="knob-value" id="wahValue">0%</div>
                    </div>
                    <div class="effect-knob">
                        <div class="knob" onclick="adjustLiveEffect('chorus')"></div>
                        <div class="knob-label">Chorus</div>
                        <div class="knob-value" id="chorusValue">0%</div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" onclick="killAllEffects()">Kill Effects</button>
                    <button class="btn" onclick="randomizeEffects()">Random Mode</button>
                </div>
            </div>
            
            <div class="section">
                <h3>üéµ Genre Presets</h3>
                <div class="genre-grid">
                    <button class="btn" onclick="setLiveGenre('motown')">Motown</button>
                    <button class="btn" onclick="setLiveGenre('blues')">Blues</button>
                    <button class="btn" onclick="setLiveGenre('jazz')">Jazz</button>
                    <button class="btn" onclick="setLiveGenre('rock')">Rock</button>
                    <button class="btn" onclick="setLiveGenre('funk')">Funk</button>
                    <button class="btn" onclick="setLiveGenre('psychedelic')">Psychedelic</button>
                </div>
                <div class="guitar-strings" id="guitarStrings">
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                    <div class="string"></div>
                </div>
            </div>
            
            <div class="section">
                <h3>ü•Å Rhythm Patterns</h3>
                <div class="rhythm-grid">
                    <button class="btn" onclick="playRhythm('1_2')">1&2</button>
                    <button class="btn" onclick="playRhythm('triplet')">Triplet</button>
                    <button class="btn" onclick="playRhythm('syncopated')">Syncopated</button>
                    <button class="btn" onclick="playRhythm('boogie')">Boogie</button>
                </div>
                <div class="bpm-control">
                    <button class="btn small" onclick="adjustBPM(-5)">-5</button>
                    <div class="bpm-display" id="bpmDisplay">120 BPM</div>
                    <button class="btn small" onclick="adjustBPM(5)">+5</button>
                </div>
                <button class="btn" onclick="playRhythmMode()" id="rhythmPlayBtn">Play Rhythm</button>
            </div>
            
            <div class="section">
                <h3>üé§ Recording Studio</h3>
                <div class="record-section">
                    <button class="btn" id="audioRecordBtn" onclick="toggleAudioRecord()">Audio Record</button>
                    <button class="btn" id="videoRecordBtn" onclick="toggleVideoRecord()">Video Record</button>
                </div>
                <div class="record-section">
                    <button class="btn" onclick="exportLiveTrack()">Export Track</button>
                    <button class="btn" onclick="saveLiveSession()">Save Session</button>
                    <button class="btn" onclick="loadLiveSession()">Load Session</button>
                </div>
            </div>
            
            <div class="section speech-section">
                <h3>üó£Ô∏è Speech Control</h3>
                <div class="speech-controls">
                    <button class="btn" id="speechBtn" onclick="toggleSpeechRecognition()">Start Speech</button>
                    <button class="btn" onclick="speakStatus()">Speak Status</button>
                </div>
                <div class="speech-commands" id="speechCommands">
                    Speech commands: "play blues", "add reverb", "record audio", "export track", "random effects"
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Audio Status</div>
                    <div class="status-value" id="audioStatus">DISCONNECTED</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Video Status</div>
                    <div class="status-value" id="videoStatus">STOPPED</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Current Genre</div>
                    <div class="status-value" id="genreStatus">NONE</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Recording</div>
                    <div class="status-value" id="recordingStatus">IDLE</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Speech</div>
                    <div class="status-value" id="speechStatus">OFF</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Session Timer</div>
                    <div class="status-value" id="sessionTimer">00:00</div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <h3>üåå Live Performance Ready! üé∏</h3>
            <p>Professional console for live rock and blues performances with speech control!</p>
            <p><em>Peace and Universal Harmony! œàŒ©¬ß‚àû</em></p>
        </div>
    </div>

    <script>
        // Global variables
        let liveAudioContext, liveSource, liveAnalyser;
        let liveVideoStream, liveAudioStream;
        let liveAudioRecorder, liveVideoRecorder;
        let liveAudioChunks = [], liveVideoChunks = [];
        let liveIsAudioRecording = false, liveIsVideoRecording = false;
        let liveCurrentGenre = 'none';
        let liveCurrentBPM = 120;
        let liveCurrentRhythm = null;
        let liveRhythmInterval = null;
        let liveSessionStartTime = Date.now();
        let liveSpeechRecognition = null;
        let liveIsSpeechActive = false;
        
        // Effects chain
        let liveEffectsChain = {
            inputGain: null,
            drive: null,
            filter: null,
            reverb: null,
            delay: null,
            delayFeedback: null,
            chorus: null,
            chorusLFO: null,
            outputGain: null
        };
        
        let liveEffects = {
            slide: 0,
            drive: 0,
            reverb: 0,
            delay: 0,
            wah: 0,
            chorus: 0
        };

        // Initialize on load
        window.onload = function() {
            connectLiveAudio();
            initializeSpeechRecognition();
            startSessionTimer();
            updateStatus('Live Console initialized! üé∏');
        };

        // Enhanced Audio Connection with Full Effects Chain
        async function connectLiveAudio() {
            try {
                liveAudioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 44100
                    }
                });

                liveAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                liveSource = liveAudioContext.createMediaStreamSource(liveAudioStream);
                liveAnalyser = liveAudioContext.createAnalyser();
                liveAnalyser.fftSize = 2048;

                // Create professional effects chain
                createLiveEffectsChain();
                
                // Connect the audio chain
                connectLiveAudioChain();

                document.getElementById('audioStatus').textContent = 'CONNECTED';
                updateStatus('Audio connected with professional effects chain! üé∏');

            } catch (error) {
                updateStatus(`Audio connection failed: ${error.message}`);
                console.error('Audio connection error:', error);
            }
        }

        // Create Professional Effects Chain
        function createLiveEffectsChain() {
            if (!liveAudioContext) return;

            // Input/Output gains
            liveEffectsChain.inputGain = liveAudioContext.createGain();
            liveEffectsChain.outputGain = liveAudioContext.createGain();

            // Drive (distortion)
            liveEffectsChain.drive = liveAudioContext.createWaveShaper();
            liveEffectsChain.drive.curve = createDistortionCurve(0);

            // Wah filter
            liveEffectsChain.filter = liveAudioContext.createBiquadFilter();
            liveEffectsChain.filter.type = 'bandpass';
            liveEffectsChain.filter.frequency.setValueAtTime(1000, liveAudioContext.currentTime);
            liveEffectsChain.filter.Q.setValueAtTime(10, liveAudioContext.currentTime);

            // Reverb
            liveEffectsChain.reverb = liveAudioContext.createConvolver();
            createLiveReverbImpulse();

            // Delay
            liveEffectsChain.delay = liveAudioContext.createDelay(1);
            liveEffectsChain.delayFeedback = liveAudioContext.createGain();
            liveEffectsChain.delay.delayTime.setValueAtTime(0.3, liveAudioContext.currentTime);
            liveEffectsChain.delayFeedback.gain.setValueAtTime(0.3, liveAudioContext.currentTime);

            // Chorus
            liveEffectsChain.chorus = liveAudioContext.createDelay(0.05);
            liveEffectsChain.chorusLFO = liveAudioContext.createOscillator();
            liveEffectsChain.chorusLFO.type = 'sine';
            liveEffectsChain.chorusLFO.frequency.setValueAtTime(2, liveAudioContext.currentTime);
            
            const chorusGain = liveAudioContext.createGain();
            chorusGain.gain.setValueAtTime(0.005, liveAudioContext.currentTime);
            liveEffectsChain.chorusLFO.connect(chorusGain);
            chorusGain.connect(liveEffectsChain.chorus.delayTime);
            liveEffectsChain.chorusLFO.start();

            // Set initial gains
            liveEffectsChain.inputGain.gain.setValueAtTime(0.8, liveAudioContext.currentTime);
            liveEffectsChain.outputGain.gain.setValueAtTime(0.7, liveAudioContext.currentTime);

            updateStatus('Professional effects chain created! üéõÔ∏è');
        }

        // Connect Audio Chain
        function connectLiveAudioChain() {
            // Main signal path
            liveSource.connect(liveEffectsChain.inputGain);
            liveEffectsChain.inputGain.connect(liveEffectsChain.drive);
            liveEffectsChain.drive.connect(liveEffectsChain.filter);
            liveEffectsChain.filter.connect(liveEffectsChain.reverb);
            liveEffectsChain.reverb.connect(liveEffectsChain.delay);
            liveEffectsChain.delay.connect(liveEffectsChain.chorus);
            liveEffectsChain.chorus.connect(liveEffectsChain.outputGain);
            liveEffectsChain.outputGain.connect(liveAnalyser);
            liveEffectsChain.outputGain.connect(liveAudioContext.destination);

            // Delay feedback loop
            liveEffectsChain.delay.connect(liveEffectsChain.delayFeedback);
            liveEffectsChain.delayFeedback.connect(liveEffectsChain.delay);
        }

        // Create Distortion Curve
        function createDistortionCurve(amount) {
            const samples = 44100;
            const curve = new Float32Array(samples);
            const deg = Math.PI / 180;
            
            for (let i = 0; i < samples; i++) {
                const x = (i * 2) / samples - 1;
                curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
            }
            
            return curve;
        }

        // Create Reverb Impulse
        function createLiveReverbImpulse() {
            const length = liveAudioContext.sampleRate * 2; // 2 second reverb
            const impulse = liveAudioContext.createBuffer(2, length, liveAudioContext.sampleRate);
            
            for (let channel = 0; channel < impulse.numberOfChannels; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    const decay = Math.pow(1 - i / length, 2);
                    channelData[i] = (Math.random() * 2 - 1) * decay;
                }
            }
            
            liveEffectsChain.reverb.buffer = impulse;
        }

        // Adjust Live Effects
        function adjustLiveEffect(effect) {
            liveEffects[effect] = (liveEffects[effect] + 25) % 101;
            const value = liveEffects[effect];
            
            document.getElementById(effect + 'Value').textContent = value + '%';
            
            if (!liveAudioContext) return;
            
            switch (effect) {
                case 'drive':
                    liveEffectsChain.drive.curve = createDistortionCurve(value / 20);
                    break;
                case 'reverb':
                    // Reverb is controlled by wet/dry mix in the routing
                    const reverbGain = liveAudioContext.createGain();
                    reverbGain.gain.setValueAtTime(value / 100, liveAudioContext.currentTime);
                    break;
                case 'delay':
                    liveEffectsChain.delay.delayTime.setValueAtTime(value / 100 * 0.5, liveAudioContext.currentTime);
                    liveEffectsChain.delayFeedback.gain.setValueAtTime(value / 100 * 0.4, liveAudioContext.currentTime);
                    break;
                case 'wah':
                    const freq = 200 + (value / 100) * 1800;
                    liveEffectsChain.filter.frequency.setValueAtTime(freq, liveAudioContext.currentTime);
                    break;
                case 'chorus':
                    liveEffectsChain.chorusLFO.frequency.setValueAtTime(1 + value / 100 * 4, liveAudioContext.currentTime);
                    break;
            }
            
            updateStatus(`${effect}: ${value}%`);
            animateGuitarStrings();
        }

        // Kill All Effects
        function killAllEffects() {
            Object.keys(liveEffects).forEach(effect => {
                liveEffects[effect] = 0;
                document.getElementById(effect + 'Value').textContent = '0%';
            });
            
            if (liveAudioContext) {
                // Reset all effects to neutral
                liveEffectsChain.drive.curve = createDistortionCurve(0);
                liveEffectsChain.delay.delayTime.setValueAtTime(0, liveAudioContext.currentTime);
                liveEffectsChain.delayFeedback.gain.setValueAtTime(0, liveAudioContext.currentTime);
                liveEffectsChain.filter.frequency.setValueAtTime(1000, liveAudioContext.currentTime);
                liveEffectsChain.chorusLFO.frequency.setValueAtTime(2, liveAudioContext.currentTime);
            }
            
            updateStatus('All effects killed! üîá');
        }

        // Randomize Effects
        function randomizeEffects() {
            Object.keys(liveEffects).forEach(effect => {
                const randomValue = Math.floor(Math.random() * 101);
                liveEffects[effect] = randomValue;
                document.getElementById(effect + 'Value').textContent = randomValue + '%';
                adjustLiveEffect(effect);
            });
            
            updateStatus('Effects randomized! üé≤');
        }

        // Set Live Genre
        function setLiveGenre(genre) {
            liveCurrentGenre = genre;
            
            // Update button states
            document.querySelectorAll('.genre-grid .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('genreStatus').textContent = genre.toUpperCase();
            
            // Apply genre-specific effects
            applyGenreEffects(genre);
            animateGuitarStrings();
            updateStatus(`Genre: ${genre.toUpperCase()}`);
        }

        // Apply Genre-Specific Effects
        function applyGenreEffects(genre) {
            const presets = {
                motown: { drive: 25, reverb: 40, delay: 20, chorus: 60 },
                blues: { drive: 60, reverb: 70, delay: 30, wah: 40 },
                jazz: { reverb: 50, chorus: 30, delay: 10 },
                rock: { drive: 80, delay: 50, reverb: 30 },
                funk: { wah: 70, drive: 40, chorus: 20 },
                psychedelic: { delay: 90, reverb: 80, chorus: 70, drive: 30 }
            };
            
            const preset = presets[genre] || {};
            
            Object.keys(preset).forEach(effect => {
                if (liveEffects.hasOwnProperty(effect)) {
                    liveEffects[effect] = preset[effect];
                    document.getElementById(effect + 'Value').textContent = preset[effect] + '%';
                    adjustLiveEffect(effect);
                }
            });
        }

        // Animate Guitar Strings
        function animateGuitarStrings() {
            const strings = document.querySelectorAll('.string');
            strings.forEach((string, index) => {
                string.classList.add('vibrating');
                setTimeout(() => {
                    string.classList.remove('vibrating');
                }, 500 + index * 100);
            });
        }

        // BPM Control
        function adjustBPM(change) {
            liveCurrentBPM = Math.max(60, Math.min(200, liveCurrentBPM + change));
            document.getElementById('bpmDisplay').textContent = liveCurrentBPM + ' BPM';
            updateStatus(`BPM: ${liveCurrentBPM}`);
        }

        // Rhythm Patterns
        function playRhythm(pattern) {
            if (liveRhythmInterval) {
                clearInterval(liveRhythmInterval);
            }
            
            liveCurrentRhythm = pattern;
            
            // Update button states
            document.querySelectorAll('.rhythm-grid .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateStatus(`Rhythm: ${pattern.toUpperCase()}`);
            animateGuitarStrings();
        }

        function playRhythmMode() {
            const btn = document.getElementById('rhythmPlayBtn');
            
            if (liveRhythmInterval) {
                clearInterval(liveRhythmInterval);
                liveRhythmInterval = null;
                btn.textContent = 'Play Rhythm';
                btn.classList.remove('active');
                updateStatus('Rhythm stopped');
            } else {
                const interval = 60000 / liveCurrentBPM; // milliseconds per beat
                liveRhythmInterval = setInterval(() => {
                    animateGuitarStrings();
                }, interval);
                
                btn.textContent = 'Stop Rhythm';
                btn.classList.add('active');
                updateStatus(`Playing rhythm at ${liveCurrentBPM} BPM`);
            }
        }

        // Video Control
        async function toggleVideo() {
            const video = document.getElementById('guitarVideo');
            
            try {
                if (!liveVideoStream) {
                    liveVideoStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 },
                        audio: false
                    });
                    
                    video.srcObject = liveVideoStream;
                    document.getElementById('videoStatus').textContent = 'LIVE';
                    updateStatus('Video feed started! üìπ');
                } else {
                    liveVideoStream.getTracks().forEach(track => track.stop());
                    liveVideoStream = null;
                    video.srcObject = null;
                    document.getElementById('videoStatus').textContent = 'STOPPED';
                    updateStatus('Video feed stopped');
                }
            } catch (error) {
                updateStatus(`Video failed: ${error.message}`);
            }
        }

        // Audio Recording
        async function toggleAudioRecord() {
            if (!liveIsAudioRecording) {
                try {
                    if (!liveAudioStream) {
                        liveAudioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    }
                    
                    liveAudioRecorder = new MediaRecorder(liveAudioStream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    liveAudioChunks = [];
                    
                    liveAudioRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            liveAudioChunks.push(event.data);
                        }
                    };
                    
                    liveAudioRecorder.onstop = function() {
                        document.getElementById('recordingStatus').textContent = 'IDLE';
                        document.getElementById('audioRecordBtn').textContent = 'Audio Record';
                        document.getElementById('audioRecordBtn').classList.remove('active');
                        updateStatus('Audio recording stopped - ready to export! üéµ');
                    };
                    
                    liveAudioRecorder.start(1000);
                    liveIsAudioRecording = true;
                    
                    document.getElementById('recordingStatus').textContent = 'AUDIO';
                    document.getElementById('audioRecordBtn').textContent = 'Stop Audio';
                    document.getElementById('audioRecordBtn').classList.add('active');
                    updateStatus('Audio recording started! üî¥');
                    
                } catch (error) {
                    updateStatus(`Audio recording failed: ${error.message}`);
                }
            } else {
                if (liveAudioRecorder && liveAudioRecorder.state === 'recording') {
                    liveAudioRecorder.stop();
                }
                liveIsAudioRecording = false;
            }
        }

        // Video Recording
        async function toggleVideoRecord() {
            if (!liveIsVideoRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 },
                        audio: true
                    });
                    
                    liveVideoRecorder = new MediaRecorder(stream, {
                        mimeType: 'video/webm;codecs=vp8,opus'
                    });
                    
                    liveVideoChunks = [];
                    
                    liveVideoRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            liveVideoChunks.push(event.data);
                        }
                    };
                    
                    liveVideoRecorder.onstop = function() {
                        document.getElementById('recordingStatus').textContent = 'IDLE';
                        document.getElementById('videoRecordBtn').textContent = 'Video Record';
                        document.getElementById('videoRecordBtn').classList.remove('active');
                        updateStatus('Video recording stopped - ready to export! üé¨');
                    };
                    
                    liveVideoRecorder.start(1000);
                    liveIsVideoRecording = true;
                    
                    document.getElementById('recordingStatus').textContent = 'VIDEO';
                    document.getElementById('videoRecordBtn').textContent = 'Stop Video';
                    document.getElementById('videoRecordBtn').classList.add('active');
                    updateStatus('Video recording started! üé¨');
                    
                } catch (error) {
                    updateStatus(`Video recording failed: ${error.message}`);
                }
            } else {
                if (liveVideoRecorder && liveVideoRecorder.state === 'recording') {
                    liveVideoRecorder.stop();
                }
                liveIsVideoRecording = false;
            }
        }

        // Export Track with Enhanced Functionality
        function exportLiveTrack() {
            let exported = false;
            
            // Export video if available
            if (liveVideoChunks.length > 0) {
                const blob = new Blob(liveVideoChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                a.href = url;
                a.download = `kozmic-live-video-${liveCurrentGenre}-${timestamp}.webm`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                liveVideoChunks = [];
                exported = true;
                updateStatus('Video exported successfully! üé¨');
            }
            
            // Export audio if available
            if (liveAudioChunks.length > 0) {
                const blob = new Blob(liveAudioChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                a.href = url;
                a.download = `kozmic-live-audio-${liveCurrentGenre}-${timestamp}.webm`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                liveAudioChunks = [];
                exported = true;
                updateStatus('Audio exported successfully! üéµ');
            }
            
            if (!exported) {
                updateStatus('No recordings to export! Record something first.');
            }
        }

        // Session Management
        function saveLiveSession() {
            const sessionData = {
                name: `Live-${Date.now()}`,
                genre: liveCurrentGenre,
                bpm: liveCurrentBPM,
                effects: { ...liveEffects },
                rhythm: liveCurrentRhythm,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(sessionData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kozmic-live-session-${Date.now()}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            updateStatus('Live session saved successfully! üíæ');
        }

        async function loadLiveSession() {
            try {
                if ('showOpenFilePicker' in window) {
                    const [fileHandle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'Kozmic Live Sessions',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    
                    const file = await fileHandle.getFile();
                    const sessionData = JSON.parse(await file.text());
                    
                    // Apply session data
                    if (sessionData.genre) {
                        setLiveGenre(sessionData.genre);
                    }
                    if (sessionData.bpm) {
                        liveCurrentBPM = sessionData.bpm;
                        document.getElementById('bpmDisplay').textContent = liveCurrentBPM + ' BPM';
                    }
                    if (sessionData.effects) {
                        Object.assign(liveEffects, sessionData.effects);
                        Object.keys(liveEffects).forEach(effect => {
                            document.getElementById(effect + 'Value').textContent = liveEffects[effect] + '%';
                            adjustLiveEffect(effect);
                        });
                    }
                    
                    updateStatus('Live session loaded successfully! üåå');
                    
                } else {
                    // Fallback for older browsers
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.click();
                    // Implementation similar to above but with FileReader
                }
                
            } catch (error) {
                updateStatus(`Session load failed: ${error.message}`);
            }
        }

        // Speech Recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                liveSpeechRecognition = new SpeechRecognition();
                liveSpeechRecognition.continuous = true;
                liveSpeechRecognition.interimResults = false;
                liveSpeechRecognition.lang = 'en-US';
                
                liveSpeechRecognition.onresult = function(event) {
                    const command = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                    processSpeechCommand(command);
                };
                
                liveSpeechRecognition.onerror = function(event) {
                    updateStatus(`Speech error: ${event.error}`);
                };
                
                updateStatus('Speech recognition initialized! üó£Ô∏è');
            } else {
                updateStatus('Speech recognition not supported in this browser');
            }
        }

        function toggleSpeechRecognition() {
            if (!liveSpeechRecognition) {
                updateStatus('Speech recognition not available');
                return;
            }
            
            if (!liveIsSpeechActive) {
                liveSpeechRecognition.start();
                liveIsSpeechActive = true;
                document.getElementById('speechBtn').textContent = 'Stop Speech';
                document.getElementById('speechBtn').classList.add('active');
                document.getElementById('speechStatus').textContent = 'LISTENING';
                updateStatus('Speech recognition started! üé§');
            } else {
                liveSpeechRecognition.stop();
                liveIsSpeechActive = false;
                document.getElementById('speechBtn').textContent = 'Start Speech';
                document.getElementById('speechBtn').classList.remove('active');
                document.getElementById('speechStatus').textContent = 'OFF';
                updateStatus('Speech recognition stopped');
            }
        }

        function processSpeechCommand(command) {
            updateStatus(`Speech: "${command}"`);
            
            // Genre commands
            if (command.includes('play blues')) setLiveGenre('blues');
            else if (command.includes('play motown')) setLiveGenre('motown');
            else if (command.includes('play jazz')) setLiveGenre('jazz');
            else if (command.includes('play rock')) setLiveGenre('rock');
            else if (command.includes('play funk')) setLiveGenre('funk');
            else if (command.includes('play psychedelic')) setLiveGenre('psychedelic');
            
            // Effect commands
            else if (command.includes('add reverb')) adjustLiveEffect('reverb');
            else if (command.includes('add delay')) adjustLiveEffect('delay');
            else if (command.includes('add drive')) adjustLiveEffect('drive');
            else if (command.includes('add chorus')) adjustLiveEffect('chorus');
            else if (command.includes('add wah')) adjustLiveEffect('wah');
            
            // Recording commands
            else if (command.includes('record audio')) toggleAudioRecord();
            else if (command.includes('record video')) toggleVideoRecord();
            else if (command.includes('export track')) exportLiveTrack();
            
            // Control commands
            else if (command.includes('kill effects')) killAllEffects();
            else if (command.includes('random effects')) randomizeEffects();
            else if (command.includes('save session')) saveLiveSession();
            
            // BPM commands
            else if (command.includes('faster')) adjustBPM(10);
            else if (command.includes('slower')) adjustBPM(-10);
            
            // Unknown command
            else {
                updateStatus(`Unknown command: "${command}"`);
            }
        }

        function speakStatus() {
            if ('speechSynthesis' in window) {
                const statusText = `Current genre: ${liveCurrentGenre}. BPM: ${liveCurrentBPM}. Recording status: ${document.getElementById('recordingStatus').textContent}`;
                const utterance = new SpeechSynthesisUtterance(statusText);
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
                updateStatus('Speaking status... üó£Ô∏è');
            } else {
                updateStatus('Speech synthesis not supported');
            }
        }

        // Session Timer
        function startSessionTimer() {
            setInterval(() => {
                const elapsed = Date.now() - liveSessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Status Update System
        function updateStatus(message) {
            console.log('Live Console:', message);
            
            // Also update speech commands display with recent commands
            const commandsDiv = document.getElementById('speechCommands');
            const currentTime = new Date().toLocaleTimeString();
            commandsDiv.innerHTML = `[${currentTime}] ${message}<br>` + commandsDiv.innerHTML;
            
            // Keep only last 3 commands visible
            const lines = commandsDiv.innerHTML.split('<br>');
            if (lines.length > 4) {
                commandsDiv.innerHTML = lines.slice(0, 4).join('<br>');
            }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case '1':
                        e.preventDefault();
                        setLiveGenre('blues');
                        break;
                    case '2':
                        e.preventDefault();
                        setLiveGenre('rock');
                        break;
                    case '3':
                        e.preventDefault();
                        setLiveGenre('motown');
                        break;
                    case 'r':
                        e.preventDefault();
                        toggleAudioRecord();
                        break;
                    case 'v':
                        e.preventDefault();
                        toggleVideoRecord();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportLiveTrack();
                        break;
                    case 's':
                        e.preventDefault();
                        saveLiveSession();
                        break;
                    case 'k':
                        e.preventDefault();
                        killAllEffects();
                        break;
                    case 'space':
                        e.preventDefault();
                        toggleSpeechRecognition();
                        break;
                }
            }
            
            // Arrow keys for BPM
            if (e.key === 'ArrowUp' && e.shiftKey) {
                e.preventDefault();
                adjustBPM(5);
            } else if (e.key === 'ArrowDown' && e.shiftKey) {
                e.preventDefault();
                adjustBPM(-5);
            }
        });

        // Touch Gestures for Mobile
        let touchStartX = 0;
        let touchStartY = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // Horizontal swipes for genre changes
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 100) {
                const genres = ['blues', 'rock', 'motown', 'jazz', 'funk', 'psychedelic'];
                const currentIndex = genres.indexOf(liveCurrentGenre);
                
                if (deltaX > 0) {
                    // Swipe right - next genre
                    const nextIndex = (currentIndex + 1) % genres.length;
                    setLiveGenre(genres[nextIndex]);
                } else {
                    // Swipe left - previous genre
                    const prevIndex = (currentIndex - 1 + genres.length) % genres.length;
                    setLiveGenre(genres[prevIndex]);
                }
            }
            
            // Vertical swipes for BPM
            if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 100) {
                if (deltaY < 0) {
                    // Swipe up - increase BPM
                    adjustBPM(10);
                } else {
                    // Swipe down - decrease BPM
                    adjustBPM(-10);
                }
            }
        });

        // Auto-save session data
        setInterval(() => {
            const sessionData = {
                genre: liveCurrentGenre,
                bpm: liveCurrentBPM,
                effects: { ...liveEffects },
                rhythm: liveCurrentRhythm,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage as backup
            try {
                localStorage.setItem('kozmicLiveSession', JSON.stringify(sessionData));
            } catch (e) {
                // Handle localStorage errors gracefully
            }
        }, 30000); // Auto-save every 30 seconds

        // Load auto-saved session on startup
        try {
            const savedSession = localStorage.getItem('kozmicLiveSession');
            if (savedSession) {
                const sessionData = JSON.parse(savedSession);
                if (sessionData.genre && sessionData.genre !== 'none') {
                    setTimeout(() => {
                        updateStatus('Restored previous session üìÇ');
                    }, 2000);
                }
            }
        } catch (e) {
            // Handle localStorage errors gracefully
        }

        // Performance monitoring
        let frameCount = 0;
        let lastTime = performance.now();
        
        // Monitor audio performance
        if (liveAnalyser) {
            function checkAudioPerformance() {
                frameCount++;
                const currentTime = performance.now();
                
                if (currentTime - lastTime > 1000) {
                    const fps = Math.round(frameCount * 1000 / (currentTime - lastTime));
                    frameCount = 0;
                    lastTime = currentTime;
                    
                    if (fps < 30) {
                        console.log(`Live Console Audio FPS: ${fps} - Performance may be affected`);
                    }
                }
                
                requestAnimationFrame(checkAudioPerformance);
            }
            checkAudioPerformance();
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            // Stop all recordings
            if (liveIsAudioRecording && liveAudioRecorder) {
                liveAudioRecorder.stop();
            }
            if (liveIsVideoRecording && liveVideoRecorder) {
                liveVideoRecorder.stop();
            }
            
            // Stop speech recognition
            if (liveIsSpeechActive && liveSpeechRecognition) {
                liveSpeechRecognition.stop();
            }
            
            // Stop rhythm
            if (liveRhythmInterval) {
                clearInterval(liveRhythmInterval);
            }
            
            // Close audio context
            if (liveAudioContext) {
                liveAudioContext.close();
            }
            
            // Stop video stream
            if (liveVideoStream) {
                liveVideoStream.getTracks().forEach(track => track.stop());
            }
            
            // Stop audio stream
            if (liveAudioStream) {
                liveAudioStream.getTracks().forEach(track => track.stop());
            }
        });

        // Easter egg - konami code for special mode
        let konamiCode = [];
        const konamiSequence = [
            'ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown',
            'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight',
            'KeyB', 'KeyA'
        ];

        document.addEventListener('keydown', (e) => {
            konamiCode.push(e.code);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }
            
            if (konamiCode.join(',') === konamiSequence.join(',')) {
                // Activate cosmic mode!
                randomizeEffects();
                setLiveGenre('psychedelic');
                adjustBPM(Math.floor(Math.random() * 40) + 140); // 140-180 BPM
                
                updateStatus('üåå COSMIC MODE ACTIVATED! üöÄ Ultimate psychedelic experience!');
                
                // Apply special visual effects
                document.body.style.filter = 'hue-rotate(180deg) saturate(2)';
                setTimeout(() => {
                    document.body.style.filter = '';
                }, 5000);
                
                konamiCode = []; // Reset
            }
        });
    </script>
</body>
</html>
